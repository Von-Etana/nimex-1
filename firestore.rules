rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isVendor() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/vendors/$(request.auth.uid));
    }
    
    // Profiles - users can read all, write own
    match /profiles/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated() && request.auth.uid == userId || isAdmin();
    }
    
    // Vendors - public read, owner write (RESTRICTED)
    match /vendors/{vendorId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.auth.uid == vendorId;
      // Update: Allow if owner or admin, BUT prevent modifying wallet_balance, verification_status, etc.
      allow update: if isAuthenticated() && (
        isAdmin() || 
        (
          (request.auth.uid == vendorId || resource.data.user_id == request.auth.uid) &&
          request.resource.data.wallet_balance == resource.data.wallet_balance &&
          request.resource.data.verification_status == resource.data.verification_status && 
          request.resource.data.verification_badge == resource.data.verification_badge &&
          request.resource.data.total_sales == resource.data.total_sales
        )
      );
      allow delete: if isAdmin();
    }
    
    // ...

    // Transaction & Escrow (Fixed Collection Names)

    // Wallet Transactions - Read only for owner, Write only by backend (admin)
    match /wallet_transactions/{transactionId} {
      allow read: if isAuthenticated() && (
        resource.data.vendor_id == request.auth.uid || 
        resource.data.user_id == request.auth.uid || // Fallback if user_id is used
        isAdmin()
      );
      allow write: if false; // Only backend can create/update
    }

    // Escrow Transactions - Read for participants, Write only by backend (admin)
    match /escrow_transactions/{escrowId} {
      allow read: if isAuthenticated() && (
        resource.data.buyer_id == request.auth.uid || 
        resource.data.vendor_id == request.auth.uid || 
        isAdmin()
      );
      allow write: if false; // Only backend can create/release/refund
    }
    
    // Disputes - participants and admin
    match /disputes/{disputeId} {
      allow read: if isAuthenticated() && (
        resource.data.buyer_id == request.auth.uid ||
        resource.data.vendor_id == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        resource.data.buyer_id == request.auth.uid ||
        resource.data.vendor_id == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // Commissions - admin only
    match /commissions/{commissionId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Analytics - admin only
    match /analytics/{analyticsId} {
      allow read, write: if isAdmin();
    }

    // KYC Submissions
    match /kyc_submissions/{submissionId} {
      allow read: if isAuthenticated() && (resource.data.user_id == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.user_id == request.auth.uid;
      allow update: if isAuthenticated() && (resource.data.user_id == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }

    // Admin Role Assignments
    match /admin_role_assignments/{assignmentId} {
      allow read: if isAuthenticated() && (resource.data.user_id == request.auth.uid || isAdmin());
      allow write: if isAdmin();
    }

    // Admin Roles & Permissions
    match /admin_roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /admin_permissions/{permId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /role_permissions/{permId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
